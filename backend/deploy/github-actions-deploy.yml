# GitHub Actions workflow for deploying to Azure Container Apps
# Save as .github/workflows/deploy.yml in your repository
#
# Required secrets:
#   AZURE_CREDENTIALS - Azure service principal credentials (JSON)
#   ACR_LOGIN_SERVER  - Azure Container Registry login server
#   ACR_USERNAME      - ACR username
#   ACR_PASSWORD      - ACR password

name: Deploy to Azure Container Apps

on:
  push:
    branches: [backend]
    paths:
      - 'backend/**'
  workflow_dispatch:

env:
  IMAGE_NAME: label-verification-backend
  RESOURCE_GROUP: label-verification-rg
  CONTAINER_APP_NAME: label-verification-api

jobs:
  test:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt
      
      - name: Install dependencies
        run: pip install -r requirements.txt
      
      - name: Run tests
        run: python -m pytest tests/ -v --tb=short

  build-and-deploy:
    needs: test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - uses: actions/checkout@v4
      
      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Login to ACR
        uses: azure/docker-login@v1
        with:
          login-server: ${{ secrets.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}
      
      - name: Build and push image
        run: |
          docker build -t ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }} .
          docker build -t ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:latest .
          docker push ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          docker push ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:latest
      
      - name: Deploy to Container Apps
        uses: azure/container-apps-deploy-action@v1
        with:
          resourceGroup: ${{ env.RESOURCE_GROUP }}
          containerAppName: ${{ env.CONTAINER_APP_NAME }}
          imageToDeploy: ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
      
      - name: Get app URL
        id: get-url
        run: |
          URL=$(az containerapp show -n ${{ env.CONTAINER_APP_NAME }} -g ${{ env.RESOURCE_GROUP }} --query properties.configuration.ingress.fqdn -o tsv)
          echo "app_url=https://$URL" >> $GITHUB_OUTPUT
      
      - name: Health check
        run: |
          echo "Waiting for deployment..."
          sleep 30
          curl -f ${{ steps.get-url.outputs.app_url }}/api/v1/health || exit 1
          echo "âœ… Deployment successful!"
      
      - name: Summary
        run: |
          echo "## Deployment Complete ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**App URL:** ${{ steps.get-url.outputs.app_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Endpoints:**" >> $GITHUB_STEP_SUMMARY
          echo "- Health: ${{ steps.get-url.outputs.app_url }}/api/v1/health" >> $GITHUB_STEP_SUMMARY
          echo "- Docs: ${{ steps.get-url.outputs.app_url }}/docs" >> $GITHUB_STEP_SUMMARY
